<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <!-- Styles -->
  <link rel="stylesheet" href="auth.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body class="auth-body">

  <div class="ph-signup-container">
    <button class="close-btn" onclick="closeModal()">Ã—</button>

    <div style="text-align: center;">
      <h1 style="color: #fff; font-size: 28px; margin-bottom: 0;">
        <span style="color: white;">Corn</span><span style="color: #ffa31a; background: #ffa31a; color: #000; padding: 0 6px; border-radius: 4px;">Hub</span>
      </h1>
      <h2 style="font-size: 22px; margin: 10px 0;">Sign Up for Free</h2>
    </div>

    <form id="signup-form" class="ph-form">
      <input type="email" id="email" placeholder="Email" required />

      <div class="password-wrapper">
        <input type="password" id="password" placeholder="Password" required />
        <i class="fas fa-eye-slash toggle-password" data-toggle="password"></i>
      </div>

      <div class="password-wrapper">
        <input type="password" id="confirm-password" placeholder="Confirm Password" required />
        <i class="fas fa-eye-slash toggle-password" data-toggle="confirm-password"></i>
      </div>

      <div class="password-strength">
        <label>Strength:</label>
        <div id="strength-bar"><span></span></div>
        <div id="match-msg" class="match-msg"></div>
      </div>

      <button type="submit" class="ph-btn">Sign Up</button>

      <button type="button" onclick="googleSignup()" class="ph-google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" />
        Sign up with Google
      </button>

      <p class="ph-login-link">
        Already have an account? <a href="login.html">Login</a> here
      </p>
    </form>

    <!-- Email Verification Modal -->
    <div class="verify-modal" id="verify-modal">
      <div class="verify-box">
        <h2>Verify your email</h2>
        <p>
          To proceed, you must verify your email address.<br>
          We've sent a verification email to <strong id="user-email"></strong>.<br>
          Please check your inbox.
        </p>

        <button onclick="resendVerification()" class="verify-btn resend">Resend email</button>
        <button onclick="updateEmail()" class="verify-btn update">Update your email</button>
        <button onclick="continueToApp()" class="verify-btn continue">Continue</button>

        <div class="verify-status-msg" id="verify-status-msg"></div>
      </div>
    </div>
  </div>

  <!-- Firebase Config -->
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>

  <script>
    // Close modal
    function closeModal() {
      window.location.href = "index.html";
    }

    // Toggle password visibility
    document.querySelectorAll(".toggle-password").forEach(icon => {
      icon.addEventListener("click", () => {
        const input = document.getElementById(icon.dataset.toggle);
        const isVisible = input.type === "text";
        input.type = isVisible ? "password" : "text";
        icon.classList.toggle("fa-eye");
        icon.classList.toggle("fa-eye-slash");
      });
    });

    // Strength and match
    const password = document.getElementById("password");
    const confirm = document.getElementById("confirm-password");
    const matchMsg = document.getElementById("match-msg");
    const bar = document.getElementById("strength-bar").firstElementChild;

    function checkStrength(pw) {
      let score = 0;
      if (pw.length >= 6) score++;
      if (/[A-Z]/.test(pw)) score++;
      if (/\d/.test(pw)) score++;
      if (/[\W]/.test(pw)) score++;
      return score;
    }

    password.addEventListener("input", () => {
      const strength = checkStrength(password.value);
      const widths = ["0%", "25%", "50%", "75%", "100%"];
      const colors = ["red", "orange", "yellow", "lightgreen", "green"];
      bar.style.width = widths[strength];
      bar.style.background = colors[strength];
    });

    confirm.addEventListener("input", () => {
      matchMsg.textContent = confirm.value === password.value ? "Passwords match" : "Passwords do not match";
      matchMsg.style.color = confirm.value === password.value ? "#0f0" : "#f00";
    });

    // Signup
    document.getElementById("signup-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const pw = password.value;
      const confirmPw = confirm.value;

      if (pw !== confirmPw) {
        alert("Passwords do not match.");
        return;
      }

      try {
        const userCred = await auth.createUserWithEmailAndPassword(email, pw);
        await userCred.user.sendEmailVerification();

        document.getElementById("user-email").textContent = userCred.user.email;
        document.getElementById("verify-modal").style.display = "flex";
      } catch (err) {
        alert("Signup Error: " + err.message);
      }
    });

    function resendVerification() {
      const user = auth.currentUser;
      const msg = document.getElementById("verify-status-msg");
      if (user) {
        user.sendEmailVerification().then(() => {
          msg.textContent = "Verification email resent!";
          msg.style.color = "#0f0";
        }).catch(err => {
          msg.textContent = err.message;
          msg.style.color = "#f00";
        });
      }
    }

    function updateEmail() {
      alert("You can add update email functionality here.");
    }

    function continueToApp() {
      alert("Redirect user to homepage after checking verification.");
    }

    function googleSignup() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          alert("Signed up as " + result.user.displayName);
          window.location.href = "index.html";
        })
        .catch(error => {
          alert("Google Signup Failed: " + error.message);
        });
    }
  </script>

</body>
</html>
